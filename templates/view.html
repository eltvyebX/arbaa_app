{% extends "base_user.html" %}

{% block title %}لوحة الإشعارات{% endblock %}

{% block content %}

<div class="card p-3 shadow-sm">

    <h3 class="mb-3 text-center">مجلد الإشعارات</h3>

    <!-- Dashboard Boxes -->
    <div class="row text-center mb-4">
        <div class="col-6">
            <div class="stats-box p-3">
                <h5 class="text-muted">عدد الإشعارات</h5>
                <h2 class="fw-bold">{{ total_images }}</h2>
            </div>
        </div>
        <div class="col-6">
            <div class="stats-box p-3">
                <h5 class="text-muted">إجمالي المبالغ</h5>
                <h2 class="fw-bold" style="color:#59287f;">{{ total_amount }}</h2>
            </div>
        </div>
    </div>

    <!-- أزرار التحكم -->
    <div class="mb-3 text-center">
        <a href="/index" class="btn btn-primary">التقاط إشعار جديد</a>
        <form action="/delete_all" method="post" style="display:inline;">
            <button class="btn btn-danger" onclick="return confirm('هل تريد حذف كل الإشعارات؟');">حذف الكل</button>
        </form>
    </div>

    <!-- شبكة الصور -->
    {% if images %}
    <div class="images-grid">
        {% for img in images %}
            <div class="img-card" data-id="{{ img.id }}">
                <img src="/static/receipts/{{ img.file }}" class="thumbnail">

                <!-- عرض المبلغ + زر تعديل -->
                <p class="amount-label">
                    المبلغ:
                    <span class="amount-text">{{ img.amount }}</span>
                </p>

                <button class="btn btn-sm btn-outline-secondary edit-btn">تعديل</button>
                <button class="btn btn-sm btn-outline-danger delete-btn mt-1">حذف</button>

                <!-- نافذة تعديل المبلغ -->
                <div class="edit-box d-none">
                    <input type="number" inputmode="numeric" pattern="[0-9]*"
                           class="form-control amount-input" placeholder="أدخل المبلغ الجديد">

                    <button class="btn btn-success btn-sm save-edit mt-1">حفظ</button>
                    <button class="btn btn-secondary btn-sm cancel-edit mt-1">إلغاء</button>
                </div>

            </div>
        {% endfor %}
    </div>

    {% else %}
        <p class="text-muted text-center">لا توجد إشعارات محفوظة.</p>
    {% endif %}

</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox">
    <span class="close">&times;</span>
    <img id="lightbox-img" class="lightbox-img">
    <div class="navigation">
        <button id="prevBtn">&#10094;</button>
        <button id="nextBtn">&#10095;</button>
    </div>
</div>

<script>
// ------------------- Lightbox -------------------
const thumbs = document.querySelectorAll(".thumbnail");
const lightbox = document.getElementById("lightbox");
const bigImg = document.getElementById("lightbox-img");
const closeBtn = document.querySelector(".close");
let currentIndex = 0;
let imgList = Array.from(thumbs).map(t => t.src);

thumbs.forEach((t, i) => {
    t.onclick = () => {
        currentIndex = i;
        bigImg.src = imgList[i];
        lightbox.style.display = "block";
    };
});

closeBtn.onclick = () => lightbox.style.display = "none";

document.getElementById("prevBtn").onclick = () => {
    currentIndex = (currentIndex - 1 + imgList.length) % imgList.length;
    bigImg.src = imgList[currentIndex];
};

document.getElementById("nextBtn").onclick = () => {
    currentIndex = (currentIndex + 1) % imgList.length;
    bigImg.src = imgList[currentIndex];
};

// ------------------- حذف إشعار -------------------
document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.onclick = async () => {
        if (!confirm("هل تريد حذف هذا الإشعار؟")) return;

        const card = btn.closest(".img-card");
        const id = card.dataset.id;

        let res = await fetch(`/delete/${id}`, { method: "POST" });
        let data = await res.json();

        if (data.success) {
            card.remove();
            alert("تم حذف الإشعار.");
        } else {
            alert("فشل الحذف.");
        }
    };
});

// ------------------- تعديل المبلغ -------------------
document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.onclick = () => {
        const card = btn.closest(".img-card");
        card.querySelector(".edit-box").classList.remove("d-none");
    };
});

// ------------------- إلغاء تعديل -------------------
document.querySelectorAll(".cancel-edit").forEach(btn => {
    btn.onclick = () => {
        btn.closest(".edit-box").classList.add("d-none");
    };
});

// ------------------- حفظ المبلغ -------------------
document.querySelectorAll(".save-edit").forEach(btn => {
    btn.onclick = async () => {
        const card = btn.closest(".img-card");
        const id = card.dataset.id;
        const input = card.querySelector(".amount-input");
        const newAmount = input.value;

        if (newAmount.trim() === "") {
            alert("يجب إدخال المبلغ.");
            return;
        }

        let res = await fetch(`/update_amount/${id}?amount=${newAmount}`, {
            method: "POST"
        });

        let data = await res.json();

        if (data.success) {
            card.querySelector(".amount-text").innerText = newAmount;
            card.querySelector(".edit-box").classList.add("d-none");
            alert("تم تحديث المبلغ.");
        } else {
            alert("خطأ أثناء تحديث المبلغ.");
        }
    };
});
</script>

<style>
.stats-box { background:#f8f9fa; border-radius:10px; border:1px solid #ddd; }
.images-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px; }
.img-card { padding:8px; background:white; border-radius:10px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
.thumbnail { width:100%; height:120px; object-fit:contain; cursor:pointer; border-radius:6px; }
.amount-label { margin-top:6px; font-weight:bold; color:#59287f; }
.edit-box { margin-top:8px; padding:8px; background:#f4f4f4; border-radius:6px; }
.lightbox { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; }
.lightbox-img { max-width:90%; max-height:90%; margin:auto; display:block; }
.close { position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer; }
.navigation { position:absolute; top:50%; width:100%; display:flex; justify-content:space-between; padding:0 20px; }
.navigation button { color:white; font-size:40px; background:none; border:none; cursor:pointer; }
</style>

{% endblock %}
