{% extends "base_user.html" %}

{% block title %}عرض الإشعارات{% endblock %}

{% block content %}
<div class="container mt-3">

    <h3 class="text-center mb-4">الإشعارات الملتقطة</h3>

    <div class="mb-3 text-center">
        <button id="deleteAllBtn" class="btn btn-danger">حذف جميع الإشعارات</button>
        <a href="/export_pdf" class="btn btn-primary">تصدير PDF</a>
    </div>

    <div class="row">
        {% for img in images %}
        <div class="col-12 col-sm-6 col-md-4 mb-3">
            <div class="card shadow-sm">
                <img src="/static/receipts/{{ img.file }}" 
                     class="card-img-top img-fluid" 
                     style="object-fit: contain; max-height: 200px;" 
                     alt="Receipt {{ img.id }}">
                <div class="card-body p-2">
                    <p class="mb-1"><strong>المبلغ:</strong> {{ "{:,.2f}".format(img.amount) }}</p>
                    <p class="mb-1"><strong>رقم العملية:</strong> {{ img.id }}</p>
                    <button class="btn btn-sm btn-outline-danger deleteBtn" data-id="{{ img.id }}">
                        حذف
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <h5 class="mt-3">إجمالي المبالغ: <span id="totalAmount">{{ "{:,.2f}".format(total_amount) }}</span></h5>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // حذف إشعار واحد
    const deleteBtns = document.querySelectorAll(".deleteBtn");
    deleteBtns.forEach(btn => {
        btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            if (!confirm("هل أنت متأكد من حذف هذا الإشعار؟")) return;

            const res = await fetch(`/delete/${id}`, { method: "POST" });
            const data = await res.json();
            if (data.success) {
                btn.closest(".col-12").remove();
                recalcTotal();
            } else {
                alert("فشل الحذف: " + data.error);
            }
        });
    });

    // حذف كل الإشعارات
    document.getElementById("deleteAllBtn").addEventListener("click", async () => {
        if (!confirm("هل أنت متأكد من حذف جميع الإشعارات؟")) return;
        const res = await fetch("/delete_all", { method: "POST" });
        if (res.ok) {
            window.location.reload();
        } else {
            alert("فشل حذف جميع الإشعارات");
        }
    });

    // إعادة حساب الإجمالي بعد حذف أي إشعار
    function recalcTotal() {
        let total = 0;
        document.querySelectorAll(".card-body p:first-child").forEach(p => {
            total += parseFloat(p.innerText.replace(/,/g, "").replace("المبلغ:", "").trim());
        });
        document.getElementById("totalAmount").innerText = total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
});
</script>
{% endblock %}
