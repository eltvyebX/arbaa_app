{% extends "base_user.html" %}

{% block title %}التقاط الإشعار{% endblock %}

{% block content %}

<div class="card p-3 shadow-sm text-center">

    <h3 class="mb-3">التقاط صورة الإشعار</h3>

    <!-- الفيديو -->
    <video id="camera" autoplay playsinline style="width:100%; border-radius:10px; background:#000;"></video>

    <!-- رسالة الخطأ -->
    <div id="cameraError" class="alert alert-warning mt-3" style="display:none;">
        لم أستطع الوصول إلى الكاميرا الخلفية. قد يتم استخدام الكاميرا الأمامية بدلاً منها.
    </div>

    <!-- زر الالتقاط -->
    <button id="captureBtn" class="btn btn-primary w-100 mt-3" 
        style="background:#59287f; border-color:#59287f;">
        التقاط الإشعار
    </button>

    <!-- الصورة الملتقطة -->
    <canvas id="snapshotCanvas" style="display:none;"></canvas>

    <!-- إدخال المبلغ -->
    <input id="amountInput" class="form-control mt-3" 
           placeholder="أدخل المبلغ يدوياً">

    <!-- حفظ -->
    <button id="saveBtn" class="btn btn-success w-100 mt-3" disabled>
        حفظ العملية
    </button>

    <!-- زر عرض الإشعارات -->
    <a href="/view" class="btn btn-outline-primary w-100 mt-3">
        عرض الإشعارات
    </a>

</div>

<script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("snapshotCanvas");
    const captureBtn = document.getElementById("captureBtn");
    const saveBtn = document.getElementById("saveBtn");
    const camError = document.getElementById("cameraError");

    async function startCamera() {
        try {
            // نحاول الكاميرا الخلفية
            const rearStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" },
                audio: false
            });

            video.srcObject = rearStream;
        } catch (error1) {
            console.warn("تعذر تشغيل الكاميرا الخلفية:", error1);

            camError.style.display = "block";

            // نحاول الكاميرا الأمامية كـ fallback
            try {
                const frontStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                });

                video.srcObject = frontStream;
            } catch (error2) {
                console.error("No camera available:", error2);
                alert("لا توجد كاميرا متاحة على هذا الجهاز.");
            }
        }
    }

    // تشغيل الكاميرا عند فتح الصفحة
    startCamera();

    // التقاط الصورة
    captureBtn.onclick = () => {
        if (!video.srcObject) {
            alert("الكاميرا غير مفعلة.");
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        saveBtn.disabled = false;
    };

    // حفظ العملية
    saveBtn.onclick = async () => {
        const amount = document.getElementById("amountInput").value.trim();
        if (!amount) {
            alert("يرجى إدخال المبلغ.");
            return;
        }

        const imageData = canvas.toDataURL("image/png");

        const res = await fetch("/upload_from_phone", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                image_data: imageData,
                amount: amount
            })
        });

        const data = await res.json();
        if (data.success) {
            alert("تم حفظ العملية بنجاح");
            window.location.href = "/view";
        } else {
            alert("فشل الحفظ: " + data.error);
        }
    };
</script>

{% endblock %}
