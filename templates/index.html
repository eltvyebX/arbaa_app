{% extends "base_user.html" %}

{% block title %}التقاط الإشعار{% endblock %}

{% block content %}

<div class="card p-3 shadow-sm text-center">

    <h3 class="mb-3">التقاط صورة الإشعار</h3>

    <!-- الفيديو للكاميرا -->
    <video id="camera" autoplay playsinline style="width:100%; border-radius:10px;"></video>

    <!-- زر الالتقاط -->
    <button id="captureBtn" class="btn btn-primary w-100 mt-3" 
        style="background:#59287f; border-color:#59287f;">
        التقاط الإشعار
    </button>

    <!-- الصورة الملتقطة -->
    <canvas id="snapshotCanvas" style="display:none;"></canvas>

    <!-- إدخال المبلغ بعد التقاط الصورة -->
    <input id="amountInput" class="form-control mt-3" 
           placeholder="أدخل المبلغ يدوياً">

    <!-- حفظ العملية -->
    <button id="saveBtn" class="btn btn-success w-100 mt-3" disabled>
        حفظ العملية
    </button>

    <!-- زر عرض الإشعارات -->
    <a href="/view" class="btn btn-outline-primary w-100 mt-3">
        عرض الإشعارات
    </a>

</div>

<script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("snapshotCanvas");
    const captureBtn = document.getElementById("captureBtn");
    const saveBtn = document.getElementById("saveBtn");

    // ---------- فتح الكاميرا الخلفية ----------
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } }, 
        audio: false
    }).then(stream => {
        video.srcObject = stream;
    }).catch(err => {
        alert("لم أستطع الوصول إلى الكاميرا الخلفية: " + err);
    });

    // ---------- التقاط الصورة ----------
    captureBtn.onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        saveBtn.disabled = false;
    };

    // ---------- حفظ الصورة + المبلغ ----------
    saveBtn.onclick = async () => {
        const amount = document.getElementById("amountInput").value.trim();
        if (!amount) {
            alert("يرجى إدخال المبلغ.");
            return;
        }

        const imageData = canvas.toDataURL("image/png");

        const res = await fetch("/upload_from_phone", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                image_data: imageData,
                amount: amount
            })
        });

        const data = await res.json();
        if (data.success) {
            alert("تم حفظ العملية بنجاح");
            window.location.href = "/view";
        } else {
            alert("فشل الحفظ: " + data.error);
        }
    };
</script>

{% endblock %}
