{% extends "base_user.html" %}
{% block title %}Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±{% endblock %}
{% block content %}

<div class="card p-3 text-center shadow-sm">

    <h3 class="mb-3">Ø§Ù„ØªÙ‚Ø§Ø· Ø¥Ø´Ø¹Ø§Ø±</h3>

    <video id="camera" autoplay playsinline style="width:100%; border-radius:10px;"></video>

    <button class="btn btn-primary w-100 mt-3" style="background:#59287f;" onclick="takePhoto()">
        ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
    </button>

    <canvas id="snapshot" style="display:none;"></canvas>

    <!-- Ù…Ø±Ø¨Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº -->
    <div id="amount_section" style="display:none;" class="mt-3">
        <label>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº:</label>
        <input type="number" id="amount" class="form-control" placeholder="0.00">
        <button class="btn btn-success w-100 mt-2" onclick="saveOperation()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>

    <a href="/view" class="btn btn-outline-primary w-100 mt-4">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</a>

</div>

<script>
let capturedImage = "";

const video = document.getElementById("camera");
navigator.mediaDevices.getUserMedia({ video: true }).then(stream => video.srcObject = stream);

function takePhoto() {
    const canvas = document.getElementById("snapshot");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    capturedImage = canvas.toDataURL("image/png");
    document.getElementById("amount_section").style.display = "block";
}

async function saveOperation() {
    const amount = document.getElementById("amount").value;

    const res = await fetch("/upload_from_phone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            image_data: capturedImage,
            amount: amount
        })
    });

    const data = await res.json();
    if (data.success) {
        window.location.href = "/view";
    }
}
</script>

{% endblock %}
