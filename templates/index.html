{% extends "base_user.html" %}

{% block title %}التقاط إشعار جديد{% endblock %}

{% block content %}
<div class="card p-4 shadow-sm text-center">
    <h3 class="mb-4">التقاط إشعار جديد</h3>

    <video id="video" width="100%" autoplay playsinline style="border:1px solid #ccc;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div class="mt-3">
        <button class="btn btn-save-op" id="captureBtn">التقاط وحفظ الإشعار</button>
        <a href="/view" class="btn btn-view-txns">عرض جميع الإشعارات</a>
    </div>
</div>

<style>
.btn-save-op {
    background-color: #a1bf37;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin: 5px;
}
.btn-view-txns {
    background-color: #59287f;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin: 5px;
}
</style>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('captureBtn');

// الوصول للكاميرا
navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
}).catch(err => alert("لا يمكن الوصول للكاميرا: " + err));

captureBtn.addEventListener('click', function(e) {
    e.preventDefault();
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dataUrl = canvas.toDataURL('image/png');

    // إرسال الصورة عبر form POST
    const form = new FormData();
    form.append('captured_image', dataUrl);

    fetch('/upload_capture', { method: 'POST', body: form })
        .then(() => window.location.href='/view')
        .catch(err => alert("حدث خطأ عند رفع الإشعار: " + err));
});
</script>
{% endblock %}
